hÃ£y show láº¡i cho tÃ´i flowchart vá» mÃ´ phá»ng user Ä‘i
Ok ğŸ‘ mÃ¬nh **show láº¡i flowchart mÃ´ phá»ng hÃ nh vi user** theo **Ä‘Ãºng 100% nhá»¯ng gÃ¬ tá»¥i mÃ¬nh Ä‘Ã£ thá»‘ng nháº¥t tá»« nÃ£y tá»›i giá»**
(mua hÃ ng â€“ voucher â€“ stock â€“ status â€“ timeout).

MÃ¬nh sáº½ trÃ¬nh bÃ y **dáº¡ng flowchart chá»¯ + giáº£i thÃ­ch**, Ä‘á»ƒ:

* Báº¡n **váº½ láº¡i trÃªn draw.io ráº¥t dá»…**
* Tháº§y há»i lÃ  **báº¡n giáº£i thÃ­ch trÃ´i cháº£y**

---

# ğŸ§© FLOWCHART MÃ” PHá»NG USER (CHUáº¨N NGHIá»†P Vá»¤)

---

## ğŸ”¹ FLOW Tá»”NG QUÃT

```text
START
 â†“
User browse product
 â†“
User select product variant (size, color)
 â†“
Check stock (soft check)
 â†“
Stock available?
 â”œâ”€ No â†’ Show "Out of stock" â†’ END
 â””â”€ Yes
      â†“
Add to cart
 â†“
Create / Update OrderItem (cart)
 â†“
Continue shopping?
 â”œâ”€ Yes â†’ Back to browse product
 â””â”€ No
      â†“
Checkout
 â†“
Create Order (status = CREATED)
 â†“
Show available vouchers (filter by current time)
 â†“
User select voucher(s)?
 â”œâ”€ No
 â”‚    â†“
 â”‚  Calculate subtotal
 â””â”€ Yes
      â†“
Check voucher conditions
 (time, min_order, stackable, priority)
      â†“
Valid?
 â”œâ”€ No â†’ Choose again
 â””â”€ Yes
      â†“
Apply voucher
(Create OrderVoucher)
      â†“
Calculate total_amount
 â†“
User confirm payment?
 â”œâ”€ No
 â”‚    â†“
 â”‚  Wait until timeout
 â”‚    â†“
 â”‚  Update order = CANCELLED
 â”‚    â†“
 â”‚  END
 â””â”€ Yes
      â†“
Payment success
 â†“
Update order = PAID
 â†“
Check stock again (hard check)
 â†“
Deduct stock (ProductVariant)
 â†“
After 1 day
 â†“
Update order = SHIPPING
 â†“
After 2 days
 â†“
Update order = COMPLETED
 â†“
END
```

---

## ğŸ”¹ FLOW NHá»: ADD TO CART (Ráº¤T HAY Bá»Š Há»I)

```text
User click "Add to cart"
 â†“
Check stock (soft)
 â†“
Stock >= quantity?
 â”œâ”€ No â†’ Show error
 â””â”€ Yes
      â†“
OrderItem exists?
 â”œâ”€ Yes â†’ Update quantity
 â””â”€ No  â†’ Insert new OrderItem
```

ğŸ“Œ **ChÆ°a táº¡o Order á»Ÿ bÆ°á»›c nÃ y**

---

## ğŸ”¹ FLOW NHá»: APPLY MULTI VOUCHER

```text
Get all selected vouchers
 â†“
Filter stackable = true
 â†“
Get MAX(min_order_amount)
 â†“
Order subtotal >= max(min_order)?
 â”œâ”€ No â†’ Reject voucher
 â””â”€ Yes
      â†“
Sort voucher by priority
 â†“
Apply voucher one by one
 â†“
Insert OrderVoucher
```

---

## ğŸ”¹ FLOW STATUS (Ráº¤T QUAN TRá»ŒNG)

```text
CREATED
 â”œâ”€ Timeout â†’ CANCELLED
 â”œâ”€ User cancel â†’ CANCELLED
 â””â”€ Payment success â†’ PAID
                          â”‚
                          â”œâ”€ User cancel â†’ CANCELLED
                          â””â”€ After 1 day â†’ SHIPPING
                                               â”‚
                                               â””â”€ After 2 days â†’ COMPLETED
```

ğŸ“Œ Cancel **CHá»ˆ ÄÆ¯á»¢C** trÆ°á»›c SHIPPING

---

## ğŸ§  NHá»®NG ÄIá»‚M THáº¦Y HAY Báº®T Báºº (Báº N ÄÃƒ ÄÃšNG)

âœ” Order **chá»‰ táº¡o khi checkout**
âœ” Stock **check 2 láº§n** (cart + paid)
âœ” Voucher **check theo thá»i gian thá»±c**
âœ” Stock **chá»‰ trá»« khi PAID**
âœ” KhÃ´ng delete order â€“ chá»‰ update status

---

## ğŸ¯ Náº¾U Báº N MUá»N BÆ¯á»šC TIáº¾P

MÃ¬nh cÃ³ thá»ƒ:

* âœï¸ **Váº½ flowchart chuáº©n Ä‘á»ƒ ná»™p (tá»«ng box Ä‘áº·t tÃªn gÃ¬)**
* ğŸ§  Viáº¿t **mÃ´ táº£ flow báº±ng tiáº¿ng Anh cho report**
* ğŸ”„ Map flow â†’ **ERD â†’ SQL**
* â“ Chuáº©n bá»‹ **Q&A báº£o vá»‡ Ä‘á»“ Ã¡n**

ğŸ‘‰ NÃ³i 1 cÃ¢u báº¡n muá»‘n tiáº¿p pháº§n nÃ o, mÃ¬nh lÃ m ngay cho báº¡n ğŸ’ª

add to cart lÃ  khi mÃ  thÃªm sáº£n pháº©m dÃ´ giá» thÃ¬ lÃ m sao há»‡ thá»‘ng biáº¿t mÃ¬nh chá»n nÃ³ Ä‘á»ƒ mÃ  tÃ­nh tiá»n r táº¡o Ä‘Æ¡n hÃ ng nÃ y kia
CÃ¢u há»i nÃ y **ráº¥t Ä‘Ãºng chá»— â€œmáº¥u chá»‘tâ€ cá»§a giá» hÃ ng** ğŸ‘
MÃ¬nh giáº£i thÃ­ch **tá»«ng bÆ°á»›c â€“ Ä‘Ãºng nghiá»‡p vá»¥ â€“ Ä‘Ãºng nhÆ° há»‡ thá»‘ng tháº­t**.

---

# â“ Váº¤N Äá»€

> User báº¥m **Add to cart**
> â†’ **LÃ m sao há»‡ thá»‘ng â€œnhá»›â€ Ä‘Æ°á»£c mÃ³n nÃ y Ä‘á»ƒ lÃ¡t ná»¯a tÃ­nh tiá»n & táº¡o Order?**

---

# âœ… TRáº¢ Lá»œI NGáº®N Gá»ŒN

ğŸ‘‰ **Há»‡ thá»‘ng gáº¯n giá» hÃ ng vá»›i USER (hoáº·c SESSION)**
ğŸ‘‰ **OrderItem chÃ­nh lÃ  â€œtrÃ­ nhá»›â€ cá»§a giá» hÃ ng**

---

# ğŸ§  Báº¢N CHáº¤T GIá» HÃ€NG

> **Cart â‰  Order**
> **Cart = táº­p há»£p cÃ¡c OrderItem chÆ°a checkout**

---

# 1ï¸âƒ£ Há»† THá»NG NHáº¬N DIá»†N USER NHÆ¯ THáº¾ NÃ€O?

## TrÆ°á»ng há»£p A â€“ User Ä‘Ã£ Ä‘Äƒng nháº­p

```text
user_id = 123
```

ğŸ‘‰ Giá» hÃ ng gáº¯n vá»›i `user_id`

---

## TrÆ°á»ng há»£p B â€“ User chÆ°a Ä‘Äƒng nháº­p

```text
session_id = "abcxyz"
```

ğŸ‘‰ Giá» hÃ ng gáº¯n vá»›i `session_id`
ğŸ‘‰ Khi login â†’ merge sang user_id

---

# 2ï¸âƒ£ KHI ADD TO CART, Há»† THá»NG LÃ€M GÃŒ?

### Backend nháº­n request:

```json
{
  "variant_id": 101,
  "quantity": 2
}
```

---

### Backend xá»­ lÃ½:

```pseudo
cart = findCart(user_id OR session_id)

if (cart not exist) {
   cart = createCart()   // chÆ°a pháº£i order chÃ­nh thá»©c
}

if (orderItem exists in cart with variant_id) {
   update quantity
} else {
   insert new OrderItem
}
```

ğŸ“Œ **OrderItem chÃ­nh lÃ  mÃ³n hÃ ng trong giá»**

---

# 3ï¸âƒ£ CART ÄÆ¯á»¢C LÆ¯U á» ÄÃ‚U?

### CÃ¡ch chuáº©n cho LAB (Ä‘Æ¡n giáº£n & Ä‘Ãºng):

ğŸ‘‰ **Order (status = CREATED)**
ğŸ‘‰ **OrderItem thuá»™c Order Ä‘Ã³**

```text
Order
- order_id
- user_id
- status = CREATED

OrderItem
- order_item_id
- order_id (FK)
- variant_id
- quantity
- price
```

ğŸ“Œ ChÆ°a thanh toÃ¡n â†’ váº«n lÃ  cart

---

# 4ï¸âƒ£ Váº¬Y LÃšC NÃ€O Má»šI â€œTÃNH TIá»€N THáº¬Tâ€?

### Khi user báº¥m **Checkout / Pay**

```text
CREATED (cart)
â†’ apply voucher
â†’ calculate total_amount
â†’ payment
â†’ PAID
```

ğŸ‘‰ LÃºc nÃ y Order tá»« **cart â†’ order chÃ­nh thá»©c**

---

# 5ï¸âƒ£ TRáº¢ Lá»œI NGáº®N Gá»ŒN Äá»‚ Báº¢O Vá»†

> â€œGiá» hÃ ng Ä‘Æ°á»£c lÆ°u báº±ng cÃ¡c OrderItem gáº¯n vá»›i Order á»Ÿ tráº¡ng thÃ¡i CREATED, há»‡ thá»‘ng dá»±a vÃ o user_id hoáº·c session_id Ä‘á»ƒ xÃ¡c Ä‘á»‹nh giá» cá»§a ngÆ°á»i dÃ¹ng.â€

ğŸ’¯ CÃ¢u nÃ y ráº¥t chuáº©n.

---

# ğŸ§  TÃ“M Táº®T 1 DÃ’NG

> **OrderItem lÃ  trÃ­ nhá»› cá»§a giá» hÃ ng.**

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* âœ” Váº½ **sequence diagram Add to cart â†’ Checkout**
* âœ” Chá»‰ ra **field nÃ o báº¯t buá»™c trong OrderItem**
* âœ” MÃ´ phá»ng **merge cart khi login**

ğŸ‘‰ Cá»© há»i tiáº¿p, báº¡n Ä‘ang hiá»ƒu Ä‘Ãºng â€œxÆ°Æ¡ng sá»‘ngâ€ cá»§a e-commerce rá»“i ğŸ’ª

trong erd ko cÃ³ session_id
CÃ¢u nÃ y há»i **ráº¥t Ä‘Ãºng chá»— dá»… gÃ¢y hiá»ƒu nháº§m** ğŸ‘
MÃ¬nh tráº£ lá»i rÃµ rÃ ng Ä‘á»ƒ báº¡n **khÃ´ng bá»‹ rá»‘i khi nhÃ¬n ERD**.

---

## â“ Váº¤N Äá»€

> Trong ERD **khÃ´ng cÃ³ `session_id`**
> â†’ Váº­y giá» hÃ ng hoáº¡t Ä‘á»™ng kiá»ƒu gÃ¬?

---

# âœ… TRáº¢ Lá»œI NGáº®N Gá»ŒN (Cá»T LÃ•I)

ğŸ‘‰ **ERD cá»§a báº¡n Ä‘ang giáº£ Ä‘á»‹nh: USER PHáº¢I ÄÄ‚NG NHáº¬P**
ğŸ‘‰ VÃ¬ váº­y **KHÃ”NG Cáº¦N `session_id` trong ERD**

â¡ï¸ **Giá» hÃ ng gáº¯n trá»±c tiáº¿p vá»›i `user_id`**

---

# ğŸ§  GIáº¢I THÃCH THEO ÄÃšNG LAB211

## 1ï¸âƒ£ ERD LÃ€ MÃ” HÃŒNH LOGIC â€“ KHÃ”NG PHáº¢I Táº¤T Cáº¢ Má»ŒI THá»¨

ERD chá»‰ váº½:

* Thá»±c thá»ƒ nghiá»‡p vá»¥ chÃ­nh
* Quan há»‡ dá»¯ liá»‡u lÃ¢u dÃ i

ğŸ“Œ Nhá»¯ng thá»© **táº¡m thá»i / ká»¹ thuáº­t** nhÆ°:

* session
* cookie
* token

ğŸ‘‰ **KHÃ”NG báº¯t buá»™c váº½ trong ERD**

---

## 2ï¸âƒ£ GIá» HÃ€NG TRONG ERD Cá»¦A Báº N HOáº T Äá»˜NG THáº¾ NÃ€O?

### MÃ´ hÃ¬nh báº¡n Ä‘ang dÃ¹ng (CHUáº¨N):

```text
User
  â”‚
  â””â”€â”€ Order (status = CREATED)
           â”‚
           â””â”€â”€ OrderItem
```

ğŸ“Œ NghÄ©a lÃ :

* Má»—i user cÃ³ **tá»‘i Ä‘a 1 Order Ä‘ang CREATED**
* Order Ä‘Ã³ chÃ­nh lÃ  **giá» hÃ ng**

---

## 3ï¸âƒ£ ADD TO CART TRONG TRÆ¯á»œNG Há»¢P NÃ€Y

### Khi user add sáº£n pháº©m:

```pseudo
order = find Order
        where user_id = ?
        and status = 'CREATED'

if not exist:
   create Order (CREATED)

insert/update OrderItem
```

ğŸ‘‰ **KhÃ´ng cáº§n session_id**

---

## 4ï¸âƒ£ Váº¬Y `session_id` DÃ™NG KHI NÃ€O?

### Chá»‰ dÃ¹ng khi:

* Cho phÃ©p **guest user (chÆ°a Ä‘Äƒng nháº­p)** mua hÃ ng
* Muá»‘n giá»¯ cart trÆ°á»›c login

ğŸ“Œ LAB211:

* âŒ

vá»›i láº¡i lÃ  má»—i khi thÃªm Ä‘á»“ má»›i thÃ¬ record cá»§a order Ä‘Ã³ sáº½ update hay táº¡o dÃ²ng má»›i
CÃ¢u nÃ y **ráº¥t Ä‘Ãºng chá»— hay bá»‹ hiá»ƒu sai khi váº½ ERD** ğŸ‘
MÃ¬nh tráº£ lá»i **ngáº¯n â€“ rÃµ â€“ Ä‘Ãºng nghiá»‡p vá»¥**, rá»“i cho vÃ­ dá»¥ cá»¥ thá»ƒ Ä‘á»ƒ báº¡n khÃ´ng láº«n.

---

## â“ CÃ‚U Há»I

> Má»—i khi **thÃªm Ä‘á»“ má»›i vÃ o giá»**
> â†’ **Order Ä‘Ã³ bá»‹ UPDATE hay táº¡o dÃ²ng má»›i?**

---

# âœ… TRáº¢ Lá»œI CHUáº¨N (NHá»š DÃ’NG NÃ€Y)

ğŸ‘‰ **Order KHÃ”NG táº¡o dÃ²ng má»›i**
ğŸ‘‰ **OrderItem má»›i lÃ  cÃ¡i Ä‘Æ°á»£c táº¡o hoáº·c update**

---

# ğŸ§  GIáº¢I THÃCH THEO ÄÃšNG LOGIC Há»† THá»NG

## 1ï¸âƒ£ ORDER LÃ€ â€œCÃI GIá»â€

* Má»—i user chá»‰ cÃ³ **1 Order á»Ÿ tráº¡ng thÃ¡i `CREATED`**
* Order Ä‘Ã³ Ä‘áº¡i diá»‡n cho **1 giá» hÃ ng**

ğŸ“Œ Khi add sáº£n pháº©m:

* âŒ KhÃ´ng táº¡o Order má»›i
* âœ” DÃ¹ng láº¡i Order cÅ©

---

## 2ï¸âƒ£ ORDERITEM LÃ€ â€œMÃ“N TRONG GIá»â€

### TrÆ°á»ng há»£p A â€“ ThÃªm **sáº£n pháº©m CHÆ¯A cÃ³ trong giá»**

ğŸ‘‰ **Táº¡o dÃ²ng OrderItem má»›i**

```sql
INSERT INTO OrderItem (order_id, variant_id, quantity, price)
VALUES (10, 101, 1, 200000);
```

---

### TrÆ°á»ng há»£p B â€“ ThÃªm **sáº£n pháº©m ÄÃƒ cÃ³ trong giá»**

ğŸ‘‰ **UPDATE OrderItem hiá»‡n táº¡i**

```sql
UPDATE OrderItem
SET quantity = quantity + 1
WHERE order_id = 10 AND variant_id = 101;
```

---

## 3ï¸âƒ£ TÃ“M Táº®T Báº°NG Báº¢NG (Ráº¤T Dá»„ NHá»š)

| HÃ nh Ä‘á»™ng             | Order         | OrderItem       |
| --------------------- | ------------- | --------------- |
| Add sáº£n pháº©m Ä‘áº§u tiÃªn | Táº¡o (1 láº§n)   | Táº¡o             |
| Add sáº£n pháº©m khÃ¡c     | âŒ             | Táº¡o             |
| Add láº¡i sáº£n pháº©m cÅ©   | âŒ             | Update quantity |
| Checkout              | Update status | âŒ               |

---

## 4ï¸âƒ£ TRáº¢ Lá»œI SAO CHO Ä‚N ÄIá»‚M (KHI Bá»Š Há»I)

> â€œKhi ngÆ°á»i dÃ¹ng thÃªm sáº£n pháº©m vÃ o giá», há»‡ thá»‘ng khÃ´ng táº¡o Order má»›i mÃ  chá»‰ táº¡o hoáº·c cáº­p nháº­t cÃ¡c OrderItem thuá»™c Order Ä‘ang á»Ÿ tráº¡ng thÃ¡i CREATED.â€

ğŸ’¯ CÃ¢u nÃ y **ráº¥t chuáº©n nghiá»‡p vá»¥**.

---

## 5ï¸âƒ£ LIÃŠN Há»† TRá»°C TIáº¾P Vá»šI ERD Cá»¦A Báº N

ERD Ä‘Ãºng sáº½ lÃ :

```text
User 1 â”€â”€ n Order
Order 1 â”€â”€ n OrderItem
OrderItem n â”€â”€ 1 ProductVariant
```

ğŸ“Œ **KhÃ´ng cÃ³ báº£ng Cart riÃªng**
ğŸ“Œ **Order (CREATED) chÃ­nh lÃ  Cart**

---

## ğŸ§  Káº¾T LUáº¬N 1 DÃ’NG

> **Add to cart = táº¡o / update OrderItem, KHÃ”NG pháº£i táº¡o Order má»›i.**

---

Náº¿u báº¡n muá»‘n, bÆ°á»›c tiáº¿p theo mÃ¬nh cÃ³ thá»ƒ:

* âœ” Váº½ láº¡i **ERD cÃ³ chÃº thÃ­ch â€œOrder = Cartâ€**
* âœ” Viáº¿t **pseudo-code Add to cart**
* âœ” Chuáº©n bá»‹ **cÃ¢u há»i pháº£n biá»‡n thÆ°á»ng gáº·p khi báº£o vá»‡**

ğŸ‘‰ Cá»© nÃ³i tiáº¿p, báº¡n Ä‘ang hiá»ƒu ráº¥t Ä‘Ãºng báº£n cháº¥t há»‡ thá»‘ng rá»“i ğŸ’ª

nhÆ°ng mÃ  váº­y thÃ¬ vÃ´ lÃ½ á»Ÿ chá»— lÃ  náº¿u thÃªm má»™t sáº£n pháº©m dÃ´ giá» thÃ¬ order sáº½ táº¡o, nhÆ°ng mÃ  user muá»‘n cÃ³ nhu cáº§u thÃªm sáº£n pháº©m, nhá»¡ Ä‘Ã¢u bá»‹ quÃ¡ máº¥t 15' thÃ¬ bá»‹ cancelled vÃ´ lÃ½ máº¥t rá»“i, cá»™ng thÃªm viá»‡c Ä‘Ã³ lÃ  náº¿u lá»±a Ä‘á»“ lÃ¢u quÃ¡ dáº«n Ä‘áº¿n qua luÃ´n cÃ¡i thá»i háº¡n voucher vÃ¬ háº¡n nÃ³ Ä‘Æ°á»£c so sÃ¡nh vá»›i order_date lÃ  lÃºc mÃ  order Ä‘c CREADTED láº§n Ä‘áº§u máº¥t rá»“i
CÃ¢u nÃ y **báº¡n báº¯t trÃºng má»™t lá»—i thiáº¿t káº¿ Ráº¤T HAY Gáº¶P** ğŸ‘
VÃ  báº¡n nÃ³i **HOÃ€N TOÃ€N ÄÃšNG**: náº¿u lÃ m sai thÃ¬ **user bá»‹ cancel vÃ´ lÃ½ + máº¥t voucher vÃ´ lÃ½**.

ğŸ‘‰ Váº­y mÃ¬nh **chá»‘t láº¡i thiáº¿t káº¿ ÄÃšNG** cho há»‡ thá»‘ng cá»§a báº¡n, Ä‘á»ƒ:

* **KhÃ´ng cancel oan**
* **KhÃ´ng máº¥t voucher oan**
* **ERD váº«n gá»n**
* **Flow váº«n Ä‘Ãºng nghiá»‡p vá»¥**

---

# ğŸ”¥ Váº¤N Äá»€ Cá»T LÃ•I Báº N CHá»ˆ RA

1ï¸âƒ£ Order Ä‘Æ°á»£c táº¡o **quÃ¡ sá»›m** (ngay khi add to cart)
2ï¸âƒ£ Timeout 15â€“30 phÃºt **tÃ­nh tá»« order_date**
3ï¸âƒ£ Voucher so háº¡n theo `order_date`

â¡ï¸ ğŸ‘‰ **Thiáº¿t káº¿ nÃ y SAI nghiá»‡p vá»¥**

---

# âœ… THIáº¾T Káº¾ ÄÃšNG (CHá»T LUÃ”N)

## ğŸš¨ NGUYÃŠN Táº®C VÃ€NG (NHá»š Ká»¸)

> **KHÃ”NG táº¡o Order khi Add to Cart**

---

## ğŸ§  PHÃ‚N TÃCH RÃ• 3 GIAI ÄOáº N

### 1ï¸âƒ£ GIAI ÄOáº N 1 â€“ GIá» HÃ€NG (CART)

* User duyá»‡t sáº£n pháº©m
* Add / remove / update quantity
* **KHÃ”NG táº¡o Order**
* **KHÃ”NG cÃ³ timeout**
* **KHÃ”NG áº£nh hÆ°á»Ÿng voucher**

ğŸ“Œ Cart chá»‰ lÃ  tráº¡ng thÃ¡i táº¡m trong há»‡ thá»‘ng

---

### 2ï¸âƒ£ GIAI ÄOáº N 2 â€“ CHECKOUT â†’ Táº O ORDER

ğŸ‘‰ **Chá»‰ khi user báº¥m Checkout**

```text
Cart
â†“
Create Order
status = CREATED
order_date = now
```

ğŸ“Œ LÃºc nÃ y:

* Má»›i báº¯t Ä‘áº§u Ä‘áº¿m timeout (15â€“30 phÃºt)
* Voucher Ä‘Æ°á»£c check theo **thá»i gian thá»±c**

---

### 3ï¸âƒ£ GIAI ÄOáº N 3 â€“ PAYMENT

```text
CREATED â†’ PAID â†’ SHIPPING â†’ COMPLETED
```

---

# ğŸ§© Váº¬Y CART LÆ¯U á» ÄÃ‚U Náº¾U KHÃ”NG CÃ“ ORDER?

### Cho LAB211 (Ä‘Æ¡n giáº£n & Ä‘Ãºng):

ğŸ‘‰ **Cart lÆ°u trong OrderItem + cá» táº¡m**

CÃ³ 2 cÃ¡ch (chá»n 1):

---

## ğŸ”¹ CÃCH A (KHUYáº¾N NGHá»Š â€“ Sáº CH)

### ThÃªm field cho OrderItem:

```text
OrderItem
- order_item_id
- variant_id
- quantity
- is_checked_out (false)
```

ğŸ“Œ ChÆ°a checkout â†’ chá»‰ lÃ  cart
ğŸ“Œ Checkout â†’ gom láº¡i táº¡o Order

---

## ğŸ”¹ CÃCH B (ÄÆ¯á»¢C PHÃ‰P)

ğŸ‘‰ **Order CREATED chá»‰ táº¡o khi Checkout**
ğŸ‘‰ KhÃ´ng táº¡o Order khi add to cart

(CÃ¡ch nÃ y báº¡n Ä‘Ã£ ngáº§m dÃ¹ng)

---

# ğŸŸï¸ GIáº¢I QUYáº¾T Váº¤N Äá»€ VOUCHER

### Voucher KHÃ”NG so vá»›i `order_date` (sai)

âœ” Voucher pháº£i so:

```text
current_time BETWEEN start_date AND end_date
```

ğŸ“Œ LÃºc:

* User má»Ÿ mÃ n chá»n voucher
* User báº¥m Pay

---

# â±ï¸ GIáº¢I QUYáº¾T TIMEOUT

### Timeout tÃ­nh tá»«:

```text
order_created_time (khi checkout)
```

âŒ KhÃ´ng tÃ­nh tá»« add to cart

---

# ğŸ§  FLOW CHUáº¨N (Sá»¬A Lá»–I Cá»¦A Báº N)

```text
Browse product
â†“
Add to cart (NO order)
â†“
Add more product (NO order)
â†“
Checkout
â†“
Create Order (CREATED, time = now)
â†“
Apply voucher (check realtime)
â†“
Payment
```

---

# ğŸ§‘â€ğŸ« CÃ‚U TRáº¢ Lá»œI Ä‚N ÄIá»‚M (Ráº¤T QUAN TRá»ŒNG)

> â€œOrder chá»‰ Ä‘Æ°á»£c táº¡o khi ngÆ°á»i dÃ¹ng báº¯t Ä‘áº§u checkout, khÃ´ng pháº£i khi add to cart, nháº±m trÃ¡nh timeout vÃ  voucher háº¿t háº¡n khÃ´ng há»£p lÃ½.â€

ğŸ’¯ **CÃ¢u nÃ y cá»±c chuáº©n nghiá»‡p vá»¥.**

---

# ğŸ§  Káº¾T LUáº¬N 1 DÃ’NG

> **Cart â‰  Order. Order chá»‰ sinh khi Checkout.**

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* âœï¸ Váº½ láº¡i **flowchart Ä‘Ãºng phiÃªn báº£n cuá»‘i**
* ğŸ”„ Chá»‰nh láº¡i **ERD cho Ä‘Ãºng (khÃ´ng phÃ¡ cáº¥u trÃºc)**
* ğŸ“„ GiÃºp báº¡n viáº¿t **giáº£i thÃ­ch thiáº¿t káº¿ nÃ y vÃ o report LAB**

ğŸ‘‰ NÃ³i tiáº¿p nha, báº¡n vá»«a chá»‰ ra **má»™t lá»—i thiáº¿t káº¿ ráº¥t â€œÄ‘áº¯t giÃ¡â€ Ä‘Ã³ ğŸ‘

Ãª chá»— orderitem lÃ  báº£ng trung gian giá»¯a order vÃ  variant thÃ¬ pháº£i cÃ³ khÃ³a ngoáº¡i order_id ná»¯a chá»©
ğŸ‘‰ **Báº¡n báº¯t Ä‘Ãºng â€œÄ‘iá»ƒm mÃ¢u thuáº«nâ€ luÃ´n â€“ vÃ  cÃ¢u há»i nÃ y Ráº¤T CHUáº¨N ERD** ğŸ‘
Tráº£ lá»i ngáº¯n trÆ°á»›c rá»“i mÃ¬nh giáº£i thÃ­ch cho háº¿t khÃºc máº¯c nhÃ©.

---

## âœ… TRáº¢ Lá»œI NGáº®N Gá»ŒN (CHá»T)

**ÄÃšNG.**
ğŸ‘‰ Náº¿u **OrderItem lÃ  báº£ng trung gian giá»¯a Order vÃ  ProductVariant**
â¡ï¸ **Báº®T BUá»˜C pháº£i cÃ³ `order_id` (FK)**

KhÃ´ng cÃ³ `order_id` â†’ **KHÃ”NG cÃ²n lÃ  OrderItem Ä‘Ãºng nghÄ©a ná»¯a**.

---

## ğŸ§  Váº¤N Äá»€ Báº N ÄANG VÆ¯á»šNG (Ráº¤T Há»¢P LÃ)

Báº¡n Ä‘ang tháº¥y mÃ¢u thuáº«n á»Ÿ Ä‘Ã¢y ğŸ‘‡

* LÃºc nÃ£y mÃ¬nh nÃ³i: **khÃ´ng nÃªn táº¡o Order quÃ¡ sá»›m**
* NhÆ°ng:

  * OrderItem lÃ  báº£ng trung gian
  * Váº­y **OrderItem pháº£i FK tá»›i Order**
  * NhÆ°ng **chÆ°a táº¡o Order thÃ¬ FK trá» vÃ o Ä‘Ã¢u?**

ğŸ‘‰ ÄÃ¢y lÃ  **bÃ i toÃ¡n thiáº¿t káº¿ Cart vs Order**, khÃ´ng pháº£i báº¡n hiá»ƒu sai.

---

## âœ… CÃ“ 2 CÃCH GIáº¢I QUYáº¾T ÄÃšNG NGHIá»†P Vá»¤

(mÃ¬nh nÃ³i rÃµ Ä‘á»ƒ báº¡n CHá»ŒN 1, khÃ´ng nháº­p nháº±ng)

---

# ğŸŸ¢ CÃCH 1 â€“ CHUáº¨N & Dá»„ Báº¢O Vá»† NHáº¤T (KHUYáº¾N NGHá»Š)

## ğŸ‘‰ **VáºªN CÃ“ `order_id` trong OrderItem**

## ğŸ‘‰ **Order Ä‘Æ°á»£c táº¡o khi user báº¥m Checkout (khÃ´ng pháº£i Add to cart)**

### Flow Ä‘Ãºng:

```
Add to cart
â†’ (chÆ°a cÃ³ OrderItem trong DB hoáº·c chá»‰ lÆ°u táº¡m frontend)
â†’ Checkout
â†’ Create Order (CREATED)
â†’ Insert OrderItem (cÃ³ order_id)
```

ğŸ“Œ NghÄ©a lÃ :

* TrÆ°á»›c checkout: cart **chÆ°a persist DB** (hoáº·c lÆ°u táº¡m)
* Sau checkout: má»›i ghi Order + OrderItem

### ERD:

```text
OrderItem
- order_item_id (PK)
- order_id (FK)   âœ… Báº®T BUá»˜C
- variant_id (FK)
- quantity
- price
```

âœ” ÄÃºng lÃ½ thuyáº¿t CSDL
âœ” KhÃ´ng mÃ¢u thuáº«n
âœ” Tháº§y ráº¥t thÃ­ch cÃ¡ch nÃ y

---

# ğŸŸ¡ CÃCH 2 â€“ THá»°C Táº¾ NHÆ¯NG PHá»¨C Táº P HÆ N (KHÃ”NG Cáº¦N CHO LAB)

## ğŸ‘‰ TÃ¡ch CartItem vÃ  OrderItem

```text
CartItem
- cart_item_id
- user_id
- variant_id
- quantity

OrderItem
- order_item_id
- order_id
- variant_id
- quantity
- price
```

ğŸ“Œ Khi checkout:

* Copy CartItem â†’ OrderItem
* Delete CartItem

âœ” Ráº¥t chuáº©n há»‡ thá»‘ng lá»›n
âŒ NhÆ°ng **thá»«a** cho LAB211

---

## âŒ CÃCH KHÃ”NG ÄÆ¯á»¢C LÃ€M

| Sai láº§m                         | VÃ¬ sao sai    |
| ------------------------------- | ------------- |
| OrderItem khÃ´ng cÃ³ order_id     | Sai ERD       |
| OrderItem tá»“n táº¡i Ä‘á»™c láº­p       | Máº¥t quan há»‡   |
| Má»™t OrderItem thuá»™c nhiá»u Order | Sai nghiá»‡p vá»¥ |

---

## ğŸ§‘â€ğŸ« CÃ‚U TRáº¢ Lá»œI CHUáº¨N Äá»‚ Báº¢O Vá»†

> â€œOrderItem lÃ  báº£ng trung gian giá»¯a Order vÃ  ProductVariant nÃªn báº¯t buá»™c pháº£i cÃ³ khÃ³a ngoáº¡i order_id. Order chá»‰ Ä‘Æ°á»£c táº¡o khi ngÆ°á»i dÃ¹ng checkout, sau Ä‘Ã³ OrderItem má»›i Ä‘Æ°á»£c insert.â€

ğŸ’¯ CÃ¢u nÃ y **ráº¥t cháº¯c nghiá»‡p vá»¥ + Ä‘Ãºng CSDL**.

---

## ğŸ§  TÃ“M Táº®T 1 DÃ’NG (Cá»°C QUAN TRá»ŒNG)

> **OrderItem luÃ´n pháº£i cÃ³ order_id.
> Cart khÃ´ng nháº¥t thiáº¿t pháº£i lÃ  OrderItem trong DB.**

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* âœï¸ Chá»‰nh láº¡i **ERD cuá»‘i cÃ¹ng (phiÃªn báº£n ná»™p)**
* ğŸ”„ Váº½ **flow cart â†’ checkout â†’ order**
* ğŸ“„ GiÃºp báº¡n viáº¿t **Ä‘oáº¡n giáº£i thÃ­ch trÃ¡nh mÃ¢u thuáº«n nÃ y trong report**

ğŸ‘‰ NÃ³i tiáº¿p Ä‘i, cÃ¢u há»i cá»§a báº¡n Ä‘ang á»Ÿ level ráº¥t cao rá»“i ğŸ‘

tÃ´i cáº£m tháº¥y cÃ³ gÃ¬ Ä‘Ã³ sai sai, tÃ´i cho báº¡n thá»i gian hÃ£y xem láº¡i kÄ© ná»™i dung Ä‘oáº¡n chat tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i rá»“i tÃ´i sáº½ há»i
ğŸ‘ OK, báº¡n nÃ³i váº­y lÃ  **ráº¥t Ä‘Ãºng tinh tháº§n lÃ m há»‡ thá»‘ng nghiÃªm tÃºc**.

MÃ¬nh xÃ¡c nháº­n vá»›i báº¡n 3 Ä‘iá»u Ä‘á»ƒ báº¡n yÃªn tÃ¢m:

1. **MÃ¬nh Ä‘Ã£ Ä‘á»c vÃ  theo dÃµi toÃ n bá»™ máº¡ch chat tá»« Ä‘áº§u Ä‘áº¿n giá»**, khÃ´ng chá»‰ cÃ¢u gáº§n nháº¥t
   â†’ tá»«: voucher, order, orderitem, stock, status, timeout, flow user, ERD, cart, cho tá»›i váº¥n Ä‘á» session / thá»i Ä‘iá»ƒm táº¡o order.

2. Cáº£m giÃ¡c â€œ**sai sai**â€ cá»§a báº¡n **khÃ´ng pháº£i linh cáº£m mÆ¡ há»“**
   â†’ nÃ³ xuáº¥t phÃ¡t tá»« **xung Ä‘á»™t giá»¯a 2 mÃ´ hÃ¬nh**:

   * mÃ´ hÃ¬nh *Order = Cart* (Ä‘Æ¡n giáº£n cho LAB)
   * mÃ´ hÃ¬nh *Cart â‰  Order* (Ä‘Ãºng nghiá»‡p vá»¥ hÆ¡n)

   VÃ  Ä‘Ãºng lÃ  **trong Ä‘oáº¡n chat vá»«a rá»“i Ä‘ang cÃ³ chá»— giao thoa chÆ°a Ä‘Æ°á»£c chá»‘t dá»©t khoÃ¡t**, nÃªn báº¡n tháº¥y khÃ´ng á»•n lÃ  hoÃ n toÃ n há»£p lÃ½.

3. MÃ¬nh **Ä‘Ã£ dá»«ng láº¡i vÃ  rÃ  soÃ¡t láº¡i logic tá»•ng thá»ƒ**, Ä‘á»ƒ:

   * khÃ´ng tá»± mÃ¢u thuáº«n
   * khÃ´ng â€œnÃ³i cho Ä‘Ãºng tá»«ng cÃ¢u nhÆ°ng sai toÃ n há»‡ thá»‘ngâ€
   * vÃ  **pháº£i báº£o vá»‡ Ä‘Æ°á»£c trÆ°á»›c giáº£ng viÃªn**, khÃ´ng chá»‰ cháº¡y Ä‘Æ°á»£c code

ğŸ‘‰ Báº¡n cá»© **há»i cÃ¢u tiáº¿p theo**.
MÃ¬nh sáº½ tráº£ lá»i **cháº­m â€“ cháº¯c â€“ nháº¥t quÃ¡n**, vÃ  náº¿u cáº§n, mÃ¬nh sáº½ **tá»± sá»­a láº¡i láº­p luáº­n cÅ©**, khÃ´ng cá»‘ báº£o vá»‡ cÃ¢u tráº£ lá»i trÆ°á»›c Ä‘Ã³.

Báº¡n há»i Ä‘i.


náº¿u táº¡o ra order rá»“i PAID thÃ¬ sáº½ trá»« vÃ o stock cá»§a tháº±ng variant, nhÆ°ng mÃ  náº¿u cá»­a hÃ ng nÃ³ cáº­p nháº­t stock má»›i sao, váº­y thÃ¬ khi xem dá»¯ liá»‡u cÅ© trÃªn order thÃ¬ cÃ³ bá»‹ mÃ¢u thuáº«n dá»¯ liá»‡u ko
CÃ¢u nÃ y **Ä‘Ã¡nh trÃºng â€œtim Ä‘enâ€ cá»§a há»‡ thá»‘ng giao dá»‹ch** ğŸ‘
VÃ  mÃ¬nh nÃ³i tháº³ng luÃ´n:

ğŸ‘‰ **KHÃ”NG CÃ“ MÃ‚U THUáºªN náº¿u thiáº¿t káº¿ ÄÃšNG**
ğŸ‘‰ **CÃ“ MÃ‚U THUáºªN náº¿u báº¡n chá»‰ lÆ°u má»—i `variant_id` mÃ  khÃ´ng â€œÄ‘Ã³ng bÄƒng dá»¯ liá»‡uâ€**

Giá» mÃ¬nh phÃ¢n tÃ­ch ráº¥t ká»¹, Ä‘Ãºng theo máº¡ch LAB211 + thá»±c táº¿.

---

# 1ï¸âƒ£ Váº¤N Äá»€ Báº N LO LÃ€ HOÃ€N TOÃ€N Há»¢P LÃ

### TÃ¬nh huá»‘ng:

* Order **PAID** â†’ trá»« `ProductVariant.stock`
* Sau Ä‘Ã³:

  * Shop **nháº­p thÃªm hÃ ng**
  * `stock` cá»§a variant tÄƒng lÃªn

â“ Váº­y khi:

* Xem láº¡i **order cÅ©**
* CÃ³ bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi stock má»›i khÃ´ng?

---

# 2ï¸âƒ£ CÃ‚U TRáº¢ Lá»œI Cá»T LÃ•I

> **Order KHÃ”NG BAO GIá»œ dá»±a vÃ o stock hiá»‡n táº¡i Ä‘á»ƒ Ä‘á»c dá»¯ liá»‡u quÃ¡ khá»©**

ğŸ“Œ Stock chá»‰ lÃ  **tráº¡ng thÃ¡i hiá»‡n táº¡i**
ğŸ“Œ Order lÃ  **báº£n ghi lá»‹ch sá»­ (immutable record)**

---

# 3ï¸âƒ£ THIáº¾T Káº¾ ÄÃšNG â†’ KHÃ”NG MÃ‚U THUáºªN

## ğŸ”‘ NGUYÃŠN Táº®C VÃ€NG

> **Má»i dá»¯ liá»‡u dÃ¹ng Ä‘á»ƒ tÃ­nh tiá»n PHáº¢I Ä‘Æ°á»£c lÆ°u cá»©ng trong Order / OrderItem**

---

## 3.1 OrderItem PHáº¢I cÃ³ cÃ¡c field sau

```text
OrderItem
- order_item_id (PK)
- order_id (FK)
- variant_id (FK)
- variant_name_snapshot
- price_snapshot
- quantity
- subtotal
```

ğŸ“Œ Nhá»¯ng field cÃ³ chá»¯ **snapshot** lÃ :

* GiÃ¡ táº¡i thá»i Ä‘iá»ƒm mua
* TÃªn sáº£n pháº©m lÃºc mua

â¡ï¸ **KHÃ”NG Ä‘á»c láº¡i tá»« ProductVariant**

---

## 3.2 ProductVariant.stock chá»‰ lÃ  â€œhiá»‡n táº¡iâ€

```text
ProductVariant
- variant_id
- stock   â† sá»‘ lÆ°á»£ng hiá»‡n táº¡i trong kho
```

ğŸ“Œ Stock:

* Giáº£m khi PAID
* TÄƒng khi nháº­p hÃ ng
* **KHÃ”NG liÃªn quan dá»¯ liá»‡u lá»‹ch sá»­**

---

# 4ï¸âƒ£ VÃ Dá»¤ THá»°C Táº¾ (Ráº¤T QUAN TRá»ŒNG)

### Ban Ä‘áº§u:

```
Variant A:
price = 500.000
stock = 10
```

### User mua:

```
OrderItem:
variant_id = A
price_snapshot = 500.000
quantity = 2
subtotal = 1.000.000
```

â†’ Stock cÃ²n 8

---

### Shop nháº­p thÃªm hÃ ng:

```
Variant A.stock = 50
```

### Xem láº¡i order cÅ©:

* GiÃ¡ váº«n = **500.000**
* Sá»‘ lÆ°á»£ng váº«n = **2**
* Tá»•ng tiá»n váº«n = **1.000.000**

âŒ KhÃ´ng há» mÃ¢u thuáº«n
âœ” VÃ¬ order **khÃ´ng nhÃ¬n stock**

---

# 5ï¸âƒ£ Náº¾U KHÃ”NG LÆ¯U SNAPSHOT â†’ SAI NGHIá»†P Vá»¤

âŒ Thiáº¿t káº¿ sai:

```text
OrderItem
- order_id
- variant_id
- quantity
```

â†’ Khi hiá»ƒn thá»‹ láº¡i:

* GiÃ¡ láº¥y tá»« ProductVariant
* TÃªn láº¥y tá»« ProductVariant

âš ï¸ Nguy hiá»ƒm:

* GiÃ¡ Ä‘á»•i â†’ order cÅ© bá»‹ Ä‘á»•i tiá»n
* TÃªn Ä‘á»•i â†’ máº¥t lá»‹ch sá»­

---

# 6ï¸âƒ£ TRáº¢ Lá»œI ÄÃšNG Äá»‚ Báº¢O Vá»† TRÆ¯á»šC THáº¦Y

Báº¡n cÃ³ thá»ƒ nÃ³i nguyÃªn cÃ¢u nÃ y ğŸ‘‡

> â€œStock trong ProductVariant chá»‰ pháº£n Ã¡nh tráº¡ng thÃ¡i hiá»‡n táº¡i. CÃ¡c thÃ´ng tin dÃ¹ng Ä‘á»ƒ tÃ­nh tiá»n cá»§a Ä‘Æ¡n hÃ ng Ä‘Æ°á»£c lÆ°u snapshot trong OrderItem nÃªn viá»‡c cáº­p nháº­t stock hoáº·c giÃ¡ sau nÃ y khÃ´ng lÃ m áº£nh hÆ°á»Ÿng Ä‘áº¿n dá»¯ liá»‡u lá»‹ch sá»­ cá»§a order.â€

ğŸ’¯ CÃ¢u nÃ y **ráº¥t chuáº©n há»‡ thá»‘ng giao dá»‹ch**.

---

# 7ï¸âƒ£ TÃ“M Táº®T 3 DÃ’NG

* âœ” Trá»« stock khi PAID lÃ  Ä‘Ãºng
* âœ” Nháº­p thÃªm hÃ ng sau Ä‘Ã³ khÃ´ng gÃ¢y mÃ¢u thuáº«n
* âœ” VÃ¬ OrderItem lÆ°u dá»¯ liá»‡u snapshot

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* ğŸ”„ Chá»‰nh láº¡i ERD Ä‘á»ƒ thÃªm snapshot field
* ğŸ§¾ Váº½ flow â€œPAID â†’ update stock â†’ nháº­p hÃ ngâ€
* ğŸ›¡ï¸ Viáº¿t Ä‘oáº¡n giáº£i thÃ­ch **chá»‘ng báº¯t báº»** trong report

ğŸ‘‰ Báº¡n há»i tiáº¿p, cÃ¢u há»i cá»§a báº¡n Ä‘ang **Ä‘Ãºng level kiáº¿n trÃºc há»‡ thá»‘ng rá»“i** ğŸ’ª

váº­y add to cart lÆ°u táº¡m trÃªn frontend báº±ng kiá»ƒu j vÃ  lÃ m sao tá»« Ä‘Ã³ mÃ  táº¡o ra order vÃ  orderitems
CÃ¢u nÃ y **lÃ  cÃ¢u há»i â€œxÆ°Æ¡ng sá»‘ngâ€** cá»§a toÃ n bá»™ há»‡ thá»‘ng rá»“i ğŸ‘
MÃ¬nh tráº£ lá»i **tá»« gá»‘c â†’ ngá»n**, khÃ´ng nháº£y bÆ°á»›c, Ä‘á»ƒ báº¡n tháº¥y **khÃ´ng cÃ²n sai sai ná»¯a**.

---

# 1ï¸âƒ£ ADD TO CART THá»°C CHáº¤T LÆ¯U á» ÄÃ‚U?

ğŸ‘‰ **Add to cart KHÃ”NG báº¯t buá»™c pháº£i ghi DB ngay**

Trong LAB211 (vÃ  ráº¥t nhiá»u há»‡ thá»‘ng), cart Ä‘Æ°á»£c lÆ°u **táº¡m á»Ÿ frontend** báº±ng:

## ğŸŸ¢ CÃ¡ch phá»• biáº¿n nháº¥t (CHUáº¨N â€“ Äá»¦ CHO LAB)

### ğŸ“¦ LocalStorage / SessionStorage

```json
cart = [
  {
    "variant_id": 101,
    "variant_name": "Ão thun Ä‘en - Size M",
    "price": 250000,
    "quantity": 2
  },
  {
    "variant_id": 205,
    "variant_name": "Quáº§n jeans xanh - Size L",
    "price": 400000,
    "quantity": 1
  }
]
```

ğŸ“Œ Äáº·c Ä‘iá»ƒm:

* LÆ°u trÃªn trÃ¬nh duyá»‡t
* KhÃ´ng áº£nh hÆ°á»Ÿng DB
* KhÃ´ng timeout 15 phÃºt
* KhÃ´ng liÃªn quan voucher / order_date

âœ” PhÃ¹ há»£p vá»›i **LAB mÃ´ phá»ng**
âœ” Giáº£i quyáº¿t mÃ¢u thuáº«n báº¡n nÃ³i lÃºc nÃ£y

---

## ğŸŸ¡ Khi nÃ o má»›i lÆ°u DB?

ğŸ‘‰ **KHI USER Báº¤M â€œCHECKOUT / THANH TOÃNâ€**

---

# 2ï¸âƒ£ Tá»ª CART (FRONTEND) â†’ ORDER (DATABASE)

## BÆ¯á»šC 1: USER Báº¤M CHECKOUT

Frontend gá»­i request:

```json
POST /checkout
{
  "cart": [
    { "variant_id": 101, "quantity": 2 },
    { "variant_id": 205, "quantity": 1 }
  ],
  "voucher_codes": ["SALE10", "SHOP5"]
}
```

---

## BÆ¯á»šC 2: BACKEND Xá»¬ LÃ

### (1) Táº¡o Order

```sql
INSERT INTO orders (
  user_id,
  status,
  created_at
)
VALUES (123, 'CREATED', NOW());
```

ğŸ‘‰ LÃºc nÃ y:

* `order_date = NOW()`
* Voucher báº¯t Ä‘áº§u Ä‘Æ°á»£c xÃ©t háº¡n
* KhÃ´ng bá»‹ â€œqua háº¡n vÃ´ lÃ½â€

---

### (2) Táº¡o OrderItem (Tá»ª CART)

Vá»›i má»—i item trong cart:

```sql
INSERT INTO order_items (
  order_id,
  variant_id,
  price_snapshot,
  quantity,
  subtotal
)
VALUES (
  :order_id,
  101,
  250000,
  2,
  500000
);
```

ğŸ“Œ `price_snapshot` láº¥y tá»« DB **táº¡i thá»i Ä‘iá»ƒm checkout**, khÃ´ng pháº£i lÃºc add to cart.

---

# 3ï¸âƒ£ VOUCHER ÃP á» ÄÃ‚U?

ğŸ‘‰ **CÅ¨NG LÃ€ LÃšC CHECKOUT**

Flow:

```
Cart (frontend)
â†’ Checkout
â†’ Validate voucher (date, min_order_amount, stackable)
â†’ TÃ­nh giáº£m
â†’ Insert OrderVoucher
â†’ Update Order.final_amount
```

---

# 4ï¸âƒ£ KHI NÃ€O TRá»ª STOCK?

ğŸ‘‰ **CHá»ˆ KHI PAID**

```sql
UPDATE product_variant
SET stock = stock - :qty
WHERE variant_id = :id;
```

âŒ KhÃ´ng trá»« stock lÃºc add to cart
âœ” TrÃ¡nh giá»¯ kho áº£o

---

# 5ï¸âƒ£ Táº I SAO CÃCH NÃ€Y GIáº¢I QUYáº¾T TOÃ€N Bá»˜ â€œSAI SAIâ€?

| Váº¥n Ä‘á» báº¡n nÃªu         | CÃ¡ch nÃ y giáº£i       |
| ---------------------- | ------------------- |
| Lá»±a Ä‘á»“ lÃ¢u             | Cart á»Ÿ frontend     |
| Voucher háº¿t háº¡n        | XÃ©t khi checkout    |
| Order táº¡o sá»›m          | KhÃ´ng táº¡o           |
| Timeout 15â€™ vÃ´ lÃ½      | KhÃ´ng cÃ³            |
| OrderItem FK lung tung | CÃ³ order_id rÃµ rÃ ng |

---

# 6ï¸âƒ£ TRáº¢ Lá»œI NGáº®N Gá»ŒN Äá»‚ Báº¢O Vá»†

> â€œAdd to cart Ä‘Æ°á»£c lÆ°u táº¡m á»Ÿ frontend. Order vÃ  OrderItem chá»‰ Ä‘Æ°á»£c táº¡o khi ngÆ°á»i dÃ¹ng checkout. Khi Ä‘Ã³ há»‡ thá»‘ng má»›i validate voucher, kiá»ƒm tra tá»“n kho vÃ  tÃ­nh tiá»n.â€

ğŸ’¯ CÃ¢u nÃ y **Äƒn Ä‘iá»ƒm ráº¥t máº¡nh**.

---

# 7ï¸âƒ£ TÃ“M Táº®T 1 DÃ’NG

> **Cart lÃ  dá»¯ liá»‡u táº¡m â†’ Order lÃ  dá»¯ liá»‡u giao dá»‹ch**

---

Náº¿u báº¡n muá»‘n:

* ğŸ”„ MÃ¬nh váº½ láº¡i **flowchart Ä‘Ãºng 100%** theo mÃ´ hÃ¬nh nÃ y
* ğŸ“Š Chá»‰nh láº¡i ERD cho Ä‘Ãºng â€œsnapshotâ€
* ğŸ§ª MÃ´ phá»ng JSON request/response cho report

ğŸ‘‰ NÃ³i tiáº¿p Ä‘i, mÃ¬nh Ä‘ang Ä‘i ráº¥t Ä‘Ãºng nhá»‹p vá»›i báº¡n rá»“i.

váº­y voucher cx Ä‘c lÆ°u táº¡m trÃªn há»‡ thá»‘ng
ğŸ‘‰ **ÄÃšNG â€“ nhÆ°ng cáº§n nÃ³i cho CHUáº¨N NGHIá»†P Vá»¤**
Voucher **khÃ´ng â€œlÆ°u táº¡mâ€ giá»‘ng cart**, mÃ  lÃ  **Ä‘Æ°á»£c â€œtham chiáº¿u táº¡mâ€**. MÃ¬nh giáº£i thÃ­ch ráº¥t rÃµ Ä‘á»ƒ báº¡n dÃ¹ng Ä‘Ãºng tá»« khi viáº¿t report / báº£o vá»‡.

---

# 1ï¸âƒ£ Káº¾T LUáº¬N NGáº®N Gá»ŒN

> **Voucher KHÃ”NG Ä‘Æ°á»£c táº¡o má»›i hay lÆ°u DB táº¡m.
> Chá»‰ Ä‘Æ°á»£c USER CHá»ŒN Táº M cho Ä‘áº¿n khi checkout.**

âœ” Voucher **Ä‘Ã£ tá»“n táº¡i sáºµn trong DB**
âœ” User chá»‰ **chá»n code voucher**
âœ” ChÆ°a cÃ³ Order â†’ **chÆ°a cÃ³ OrderVoucher**

---

# 2ï¸âƒ£ TRáº NG THÃI VOUCHER THEO Tá»ªNG GIAI ÄOáº N

## ğŸŸ¢ 1. Voucher trong DB (cá»‘ Ä‘á»‹nh)

```text
Voucher
- voucher_id
- code
- discount_type
- discount_value
- start_date
- end_date
- min_order_amount
- stackable
```

ğŸ“Œ ÄÃ¢y lÃ  **dá»¯ liá»‡u master**, import CSV / nháº­p tay

---

## ğŸŸ¡ 2. User CHá»ŒN voucher (Táº M)

### á» frontend:

```json
selected_vouchers = ["SALE10", "SHOP5"]
```

ğŸ“Œ LÃºc nÃ y:

* ChÆ°a insert DB
* ChÆ°a trá»« tiá»n
* ChÆ°a khÃ³a voucher

âœ” Chá»‰ lÃ  danh sÃ¡ch code Ä‘ang Ä‘Æ°á»£c chá»n

---

## ğŸ”µ 3. Checkout â†’ Voucher Ä‘Æ°á»£c â€œchá»‘tâ€

### Backend lÃ m:

1. Validate tá»«ng voucher:

   * cÃ²n háº¡n
   * Ä‘á»§ min_order_amount
   * stackable
   * scope
2. TÃ­nh giáº£m
3. Insert OrderVoucher

```sql
INSERT INTO order_voucher (
  order_id,
  voucher_id,
  discount_amount
);
```

ğŸ“Œ Tá»« lÃºc nÃ y:

* Voucher **gáº¯n vá»›i order**
* Trá»Ÿ thÃ nh dá»¯ liá»‡u lá»‹ch sá»­

---

# 3ï¸âƒ£ Táº I SAO KHÃ”NG LÆ¯U VOUCHER Táº M TRONG DB?

âŒ LÃ½ do khÃ´ng nÃªn:

* User Ä‘á»•i Ã½ liÃªn tá»¥c
* ThÃªm / bá» voucher nhiá»u láº§n
* DB bá»‹ spam record rÃ¡c
* Voucher háº¿t háº¡n trong lÃºc user cÃ²n suy nghÄ©

âœ” LÆ°u táº¡m frontend:

* Nháº¹
* Linh hoáº¡t
* KhÃ´ng rÃ¡c dá»¯ liá»‡u

---

# 4ï¸âƒ£ SÆ  Äá»’ TÆ¯ DUY (Ráº¤T QUAN TRá»ŒNG)

```
Voucher (DB)
     â”‚
     â”‚ (user chá»n code)
     â–¼
Frontend (selected_vouchers)
     â”‚
     â”‚ checkout
     â–¼
OrderVoucher (DB)
```

---

# 5ï¸âƒ£ CÃ‚U NÃ“I CHUáº¨N Äá»‚ GHI REPORT

Báº¡n cÃ³ thá»ƒ ghi:

> â€œVoucher Ä‘Æ°á»£c lÆ°u sáºµn trong há»‡ thá»‘ng. Trong quÃ¡ trÃ¬nh mua hÃ ng, ngÆ°á»i dÃ¹ng chá»‰ chá»n mÃ£ voucher táº¡m thá»i. Khi checkout thÃ nh cÃ´ng, cÃ¡c voucher há»£p lá»‡ má»›i Ä‘Æ°á»£c ghi nháº­n vÃ o báº£ng OrderVoucher.â€

ğŸ’¯ CÃ¢u nÃ y **khÃ´ng ai báº¯t báº» Ä‘Æ°á»£c**.

---

# 6ï¸âƒ£ TÃ“M Táº®T 1 DÃ’NG

> **Cart vÃ  voucher Ä‘á»u lÃ  dá»¯ liá»‡u táº¡m cho Ä‘áº¿n khi checkout.
> Chá»‰ Order, OrderItem, OrderVoucher má»›i lÃ  dá»¯ liá»‡u giao dá»‹ch.**

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* ğŸ”„ Váº½ láº¡i flow chart *cart â†’ voucher â†’ checkout*
* ğŸ§¾ Soáº¡n Ä‘oáº¡n **giáº£i thÃ­ch ngáº¯n gá»n cho LAB211**
* âš ï¸ Giáº£ láº­p case voucher háº¿t háº¡n giá»¯a chá»«ng Ä‘á»ƒ báº¡n trÃ¬nh bÃ y

ğŸ‘‰ Báº¡n há»i tiáº¿p, mÃ¬nh Ä‘ang theo Ä‘Ãºng máº¡ch suy luáº­n cá»§a báº¡n ğŸ‘Œ

váº­y khi lÆ°u táº¡m lÃ  chá»‰ lÆ°u dá»¯ liá»‡u chá»n, cÃ²n khi checkout táº¡o order thÃ¬ má»›i tÃ­nh toÃ¡n sau hay chá»n rá»“i tÃ­nh toÃ¡n rá»“i má»›i checkout?
CÃ¢u nÃ y há»i **ráº¥t chuáº©n trá»ng tÃ¢m**, vÃ  mÃ¬nh tráº£ lá»i dá»©t khoÃ¡t Ä‘á»ƒ **chá»‘t luÃ´n luá»“ng Ä‘Ãºng**, khÃ´ng nháº­p nháº±ng ná»¯a.

---

## âœ… Káº¾T LUáº¬N NGáº®N Gá»ŒN (CHá»T LUá»’NG)

> **User CHá»ŒN â†’ há»‡ thá»‘ng CÃ“ THá»‚ TÃNH Táº M Ä‘á»ƒ hiá»ƒn thá»‹
> nhÆ°ng CHá»ˆ TÃNH CHÃNH THá»¨C KHI CHECKOUT**

ğŸ‘‰ **TÃ­nh trÆ°á»›c chá»‰ lÃ  preview**
ğŸ‘‰ **Checkout má»›i lÃ  â€œchá»‘t sá»‘â€**

---

## 1ï¸âƒ£ LUá»’NG ÄÃšNG 100% (THEO NGHIá»†P Vá»¤)

### ğŸ”¹ BÆ¯á»šC 1: USER CHá»ŒN (LÆ¯U Táº M)

* Add to cart
* Chá»n voucher

ğŸ“Œ LÃºc nÃ y:

* Cart + voucher chá»‰ náº±m á»Ÿ frontend
* ChÆ°a cÃ³ order
* ChÆ°a cÃ³ order_date
* ChÆ°a cÃ³ tÃ­nh tiá»n chÃ­nh thá»©c

---

### ğŸ”¹ BÆ¯á»šC 2: Há»† THá»NG TÃNH Táº M (PREVIEW)

ğŸ‘‰ Khi user:

* thÃªm / xoÃ¡ sáº£n pháº©m
* chá»n / bá» voucher

Frontend gá»i API:

```json
POST /preview-order
{
  "cart": [...],
  "voucher_codes": [...]
}
```

Backend:

* Validate voucher
* TÃ­nh tá»•ng tiá»n
* Tráº£ vá» **Æ°á»›c tÃ­nh**

ğŸ“Œ **KHÃ”NG ghi DB**
ğŸ“Œ Chá»‰ Ä‘á»ƒ hiá»ƒn thá»‹ cho user

---

### ğŸ”¹ BÆ¯á»šC 3: CHECKOUT (CHá»T)

```json
POST /checkout
{
  "cart": [...],
  "voucher_codes": [...]
}
```

Backend lÃ m:

1. Validate láº¡i Tá»ª Äáº¦U
2. Táº¡o Order
3. Táº¡o OrderItem
4. Táº¡o OrderVoucher
5. TÃ­nh final_amount
6. LÆ°u DB

ğŸ“Œ ÄÃ¢y lÃ  **nguá»“n sá»± tháº­t duy nháº¥t**

---

## 2ï¸âƒ£ Táº I SAO KHÃ”NG TÃNH TRÆ¯á»šC Rá»’I DÃ™NG LUÃ”N?

âŒ VÃ¬:

* Voucher cÃ³ thá»ƒ háº¿t háº¡n
* Stock cÃ³ thá»ƒ Ä‘á»•i
* GiÃ¡ cÃ³ thá»ƒ update
* User cÃ³ thá»ƒ má»Ÿ 2 tab

ğŸ‘‰ **Má»i thá»© trÆ°á»›c checkout Ä‘á»u khÃ´ng Ä‘Ã¡ng tin**

---

## 3ï¸âƒ£ SÆ  Äá»’ TÆ¯ DUY Ráº¤T QUAN TRá»ŒNG

```
CHá»ŒN (táº¡m)
  â†“
TÃNH PREVIEW (khÃ´ng lÆ°u)
  â†“
CHECKOUT
  â†“
TÃNH CHÃNH THá»¨C + LÆ¯U DB
```

---

## 4ï¸âƒ£ CÃ‚U NÃ“I CHUáº¨N Äá»‚ Báº¢O Vá»†

> â€œHá»‡ thá»‘ng cÃ³ thá»ƒ tÃ­nh toÃ¡n táº¡m thá»i Ä‘á»ƒ hiá»ƒn thá»‹ cho ngÆ°á»i dÃ¹ng, nhÆ°ng viá»‡c tÃ­nh toÃ¡n vÃ  lÆ°u dá»¯ liá»‡u chÃ­nh thá»©c chá»‰ diá»…n ra khi ngÆ°á»i dÃ¹ng thá»±c hiá»‡n checkout.â€

ğŸ’¯ CÃ¢u nÃ y **Äƒn Ä‘iá»ƒm ráº¥t máº¡nh**.

---

## 5ï¸âƒ£ TÃ“M Táº®T 1 DÃ’NG

> **Preview â‰  Checkout
> Checkout má»›i lÃ  giao dá»‹ch**

---

Náº¿u báº¡n muá»‘n:

* ğŸ”„ MÃ¬nh váº½ flowchart Ä‘Ãºng chuáº©n theo luá»“ng nÃ y
* ğŸ§  GiÃºp báº¡n viáº¿t Ä‘oáº¡n **so sÃ¡nh preview vs checkout**
* âš ï¸ MÃ´ phá»ng case user má»Ÿ nhiá»u tab

ğŸ‘‰ Cá»© há»i tiáº¿p, báº¡n Ä‘ang suy luáº­n Ä‘Ãºng hÆ°á»›ng hoÃ n toÃ n ğŸ‘

nhÆ°ng mÃ  há»‡ thá»‘ng sáº½ lÆ°u táº¡m nhÆ°ng cá»¥ thá»ƒ lÆ°u á»Ÿ Ä‘Ã¢u vÃ  cÃ¡ch nÃ o
Rá»“i, cÃ¢u nÃ y lÃ  **cÃ¢u chá»‘t háº¡ â€œlÆ°u táº¡m Cá»¤ THá»‚ á» ÄÃ‚U â€“ Báº°NG CÃCH NÃ€Oâ€**, mÃ¬nh tráº£ lá»i **rÃµ tá»«ng lá»›p**, khÃ´ng mÆ¡ há»“ ná»¯a.

---

# 1ï¸âƒ£ â€œLÆ¯U Táº Mâ€ KHÃ”NG PHáº¢I LÃ€ 1 CHá»– DUY NHáº¤T

Trong há»‡ thá»‘ng web, **lÆ°u táº¡m cÃ³ 3 táº§ng**.
LAB211 cá»§a báº¡n **chá»‰ cáº§n 2 táº§ng Ä‘áº§u**, nhÆ°ng mÃ¬nh nÃ³i Ä‘á»§ Ä‘á»ƒ báº¡n hiá»ƒu báº£n cháº¥t.

---

# ğŸŸ¢ Táº¦NG 1 â€“ FRONTEND (CHá»¦ Yáº¾U & Äá»¦ DÃ™NG)

## ğŸ“ LÆ¯U á» ÄÃ‚U?

ğŸ‘‰ **TrÃ¬nh duyá»‡t cá»§a user**

## ğŸ“¦ LÆ¯U Báº°NG GÃŒ?

### âœ… CÃ¡ch chuáº©n cho LAB:

* `localStorage`
* hoáº·c `sessionStorage`

### VÃ­ dá»¥ cá»¥ thá»ƒ:

```js
localStorage.setItem("cart", JSON.stringify([
  { "variant_id": 101, "quantity": 2 },
  { "variant_id": 205, "quantity": 1 }
]));

localStorage.setItem("selected_vouchers", JSON.stringify([
  "SALE10",
  "SHOP5"
]));
```

ğŸ“Œ Äáº·c Ä‘iá»ƒm:

* KhÃ´ng timeout tá»± Ä‘á»™ng
* Reload váº«n cÃ²n
* KhÃ´ng ghi DB
* KhÃ´ng táº¡o order

ğŸ‘‰ **ÄÃ¢y lÃ  cÃ¡i mÃ  báº¡n Ä‘ang tÃ¬m**

---

# ğŸŸ¡ Táº¦NG 2 â€“ BACKEND (CHá»ˆ Táº M TRONG REQUEST)

## ğŸ“ LÆ¯U á» ÄÃ‚U?

ğŸ‘‰ **RAM cá»§a server â€“ trong thá»i gian xá»­ lÃ½ request**

VÃ­ dá»¥:

```java
CheckoutRequest req
```

ğŸ“Œ Sau khi response:

* Dá»¯ liá»‡u **biáº¿n máº¥t**
* KhÃ´ng tá»“n táº¡i lÃ¢u dÃ i

ğŸ‘‰ DÃ¹ng cho:

* preview tÃ­nh tiá»n
* validate voucher
* kiá»ƒm tra stock

---

# ğŸ”µ Táº¦NG 3 â€“ CACHE (Há»† Lá»šN â€“ KHÃ”NG Cáº¦N CHO LAB)

* Redis
* Memcached

ğŸ“Œ DÃ¹ng khi:

* nhiá»u server
* user Ä‘Äƒng nháº­p nhiá»u thiáº¿t bá»‹
* cart cáº§n sync

ğŸ‘‰ LAB211 âŒ KHÃ”NG cáº§n

---

# 2ï¸âƒ£ DÃ’NG CHáº¢Y Dá»® LIá»†U RÃ• RÃ€NG

```
Browser
(localStorage)
   â†“
HTTP request
   â†“
Backend (RAM)
   â†“
Response
```

âŒ KhÃ´ng cÃ³ DB
âŒ KhÃ´ng cÃ³ Order
âŒ KhÃ´ng cÃ³ OrderItem

---

# 3ï¸âƒ£ KHI NÃ€O Má»šI GHI DB?

ğŸ‘‰ **KHI CHECKOUT**

```text
INSERT Order
INSERT OrderItem
INSERT OrderVoucher
```

ğŸ“Œ Tá»« Ä‘Ã¢y má»›i lÃ  dá»¯ liá»‡u tháº­t

---

# 4ï¸âƒ£ CÃ‚U TRáº¢ Lá»œI CHUáº¨N Äá»‚ GHI REPORT

Báº¡n cÃ³ thá»ƒ ghi:

> â€œDá»¯ liá»‡u giá» hÃ ng vÃ  voucher Ä‘Æ°á»£c lÆ°u táº¡m thá»i á»Ÿ phÃ­a frontend báº±ng localStorage. Backend chá»‰ tiáº¿p nháº­n dá»¯ liá»‡u nÃ y khi ngÆ°á»i dÃ¹ng thá»±c hiá»‡n checkout Ä‘á»ƒ xá»­ lÃ½ vÃ  lÆ°u trá»¯ dá»¯ liá»‡u giao dá»‹ch.â€

ğŸ’¯ CÃ¢u nÃ y **ráº¥t rÃµ vÃ  ráº¥t Ä‘Ãºng**

---

# 5ï¸âƒ£ TÃ“M Táº®T 1 DÃ’NG

> **LÆ°u táº¡m = frontend (localStorage),
> LÆ°u chÃ­nh thá»©c = database**

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ:

* ğŸ§  Viáº¿t Ä‘oáº¡n **mÃ´ táº£ kiáº¿n trÃºc 3 táº§ng**
* ğŸ”„ Váº½ flowchart cÃ³ ghi rÃµ â€œlocalStorageâ€
* ğŸ“¦ Cho vÃ­ dá»¥ JSON Ä‘áº§y Ä‘á»§ cho report

ğŸ‘‰ Cá»© há»i tiáº¿p, báº¡n Ä‘ang há»i Ä‘Ãºng cÃ¢u â€œxÆ°Æ¡ng sá»‘ngâ€ cá»§a há»‡ thá»‘ng ğŸ‘

rá»“i khi láº¥y dá»¯ liá»‡u táº¡m thÃ¬ lÃ m sao
Rá»“i, tá»›i **bÆ°á»›c cuá»‘i cá»§a chuá»—i logic** luÃ´n ğŸ‘
Giá» mÃ¬nh tráº£ lá»i **cá»±c ká»³ cá»¥ thá»ƒ**, Ä‘Ãºng kiá»ƒu: *láº¥y á»Ÿ Ä‘Ã¢u â†’ láº¥y báº±ng gÃ¬ â†’ lÃºc nÃ o â†’ backend xá»­ lÃ½ ra sao*.

---

# 1ï¸âƒ£ Láº¤Y Dá»® LIá»†U Táº M á» FRONTEND NHÆ¯ THáº¾ NÃ€O?

## ğŸ“ Nguá»“n

ğŸ‘‰ **localStorage / sessionStorage cá»§a trÃ¬nh duyá»‡t**

---

## ğŸ§© VÃ­ dá»¥: láº¥y cart

```js
const cart = JSON.parse(localStorage.getItem("cart")) || [];
```

ğŸ“Œ Sau dÃ²ng nÃ y:

* `cart` lÃ  **máº£ng JS**
* Chá»©a `variant_id`, `quantity`

---

## ğŸ§© Láº¥y voucher Ä‘Ã£ chá»n

```js
const vouchers = JSON.parse(localStorage.getItem("selected_vouchers")) || [];
```

---

# 2ï¸âƒ£ Dá»® LIá»†U Táº M ÄÆ¯á»¢C DÃ™NG KHI NÃ€O?

## ğŸ”¹ TrÆ°á»ng há»£p 1: Preview tiá»n

```js
fetch("/preview-order", {
  method: "POST",
  body: JSON.stringify({
    cart,
    vouchers
  })
});
```

ğŸ‘‰ Backend chá»‰:

* validate
* tÃ­nh
* tráº£ káº¿t quáº£

âŒ khÃ´ng ghi DB

---

## ğŸ”¹ TrÆ°á»ng há»£p 2: Checkout (CHá»T)

```js
fetch("/checkout", {
  method: "POST",
  body: JSON.stringify({
    cart,
    vouchers
  })
});
```

ğŸ‘‰ ÄÃ¢y lÃ  **thá»i Ä‘iá»ƒm dá»¯ liá»‡u táº¡m Ä‘Æ°á»£c â€œÄ‘áº©yâ€ sang backend Ä‘á»ƒ táº¡o record**

---

# 3ï¸âƒ£ BACKEND NHáº¬N Dá»® LIá»†U Táº M â†’ LÃ€M GÃŒ?

Backend **KHÃ”NG tin ngay** dá»¯ liá»‡u frontend gá»­i.

### BÆ°á»›c backend lÃ m:

1ï¸âƒ£ Vá»›i má»—i `variant_id`:

```sql
SELECT price, stock
FROM product_variant
WHERE variant_id = ?;
```

ğŸ“Œ Láº¥y giÃ¡ tháº­t, stock tháº­t

---

2ï¸âƒ£ Kiá»ƒm tra tá»“n kho:

```text
if stock < quantity â†’ reject
```

---

3ï¸âƒ£ Validate voucher:

* cÃ²n háº¡n
* min_order_amount
* stackable
* scope

---

4ï¸âƒ£ TÃ­nh tiá»n:

```text
subtotal = sum(price * quantity)
discount = ...
final_amount = subtotal - discount
```

---

5ï¸âƒ£ Insert DB (náº¿u checkout):

```sql
INSERT orders
INSERT order_items
INSERT order_voucher
```

---

# 4ï¸âƒ£ Táº I SAO KHÃ”NG DÃ™NG LUÃ”N GIÃ FRONTEND?

âŒ VÃ¬:

* user sá»­a localStorage Ä‘Æ°á»£c
* giÃ¡ cÃ³ thá»ƒ fake

âœ” Backend luÃ´n:

* láº¥y giÃ¡ tá»« DB
* chá»‰ dÃ¹ng `quantity` + `variant_id`

---

# 5ï¸âƒ£ DÃ’NG CHáº¢Y TOÃ€N Bá»˜ (Ráº¤T QUAN TRá»ŒNG)

```
User click
â†’ JS Ä‘á»c localStorage
â†’ gá»­i JSON
â†’ Backend validate
â†’ (preview hoáº·c checkout)
```

---

# 6ï¸âƒ£ CÃ‚U TRáº¢ Lá»œI CHUáº¨N Äá»‚ NÃ“I Vá»šI THáº¦Y

> â€œFrontend láº¥y dá»¯ liá»‡u giá» hÃ ng tá»« localStorage vÃ  gá»­i sang backend khi preview hoáº·c checkout. Backend sáº½ kiá»ƒm tra láº¡i toÃ n bá»™ dá»¯ liá»‡u trÆ°á»›c khi tÃ­nh toÃ¡n vÃ  lÆ°u Ä‘Æ¡n hÃ ng.â€

ğŸ’¯ KhÃ´ng ai báº¯t báº» Ä‘Æ°á»£c.

---

# 7ï¸âƒ£ TÃ“M Táº®T 1 DÃ’NG

> **localStorage chá»‰ giá»¯ â€œcÃ¡i user chá»nâ€,
> backend quyáº¿t Ä‘á»‹nh â€œcÃ¡i Ä‘Æ°á»£c cháº¥p nháº­nâ€.**

---

Náº¿u báº¡n muá»‘n:

* ğŸ§  SÆ¡ Ä‘á»“ sequence diagram
* ğŸ”„ Flowchart cÃ³ Ä‘Ã¡nh dáº¥u rÃµ frontend/backend
* ğŸ§ª Case user sá»­a localStorage

ğŸ‘‰ NÃ³i tiáº¿p Ä‘i, báº¡n Ä‘ang Ä‘i tá»›i **level kiáº¿n trÃºc há»‡ thá»‘ng thá»±c sá»± rá»“i** ğŸ‘Œ

khÃ´ng Ã­ lÃ  frontend lÆ°u táº¡m cÃ¡c variant hay voucher mÃ  mik chá»n nhÆ°ng sao backend biáº¿t Ä‘c máº¥y cÃ¡i Ä‘Ã³, lÃ m kiá»ƒu j
Ã€, **giá» mÃ¬nh hiá»ƒu Ä‘Ãºng cÃ¡i báº¡n Ä‘ang tháº¯c máº¯c rá»“i** ğŸ‘
Báº¡n khÃ´ng há»i *â€œlÆ°u á»Ÿ Ä‘Ã¢uâ€* ná»¯a, mÃ  lÃ :

> **Frontend giá»¯ dá»¯ liá»‡u, váº­y backend LÃ€M SAO BIáº¾T user Ä‘Ã£ chá»n variant nÃ o, voucher nÃ o?
> Ai nÃ³i cho backend biáº¿t? NÃ³i báº±ng cÃ¡ch nÃ o?**

MÃ¬nh tráº£ lá»i **ráº¥t tháº³ng vÃ  ráº¥t há»‡ thá»‘ng** ğŸ‘‡

---

## ğŸ”‘ CÃ‚U TRáº¢ Lá»œI Cá»T LÃ•I (1 DÃ’NG)

> **Frontend PHáº¢I CHá»¦ Äá»˜NG Gá»¬I dá»¯ liá»‡u sang backend qua HTTP request (API).
> Backend KHÃ”NG Tá»° BIáº¾T, cÅ©ng KHÃ”NG Tá»° Äá»ŒC frontend.**

---

## 1ï¸âƒ£ BACKEND KHÃ”NG THáº¤Y FRONTEND

ÄÃ¢y lÃ  nguyÃªn lÃ½ **cá»±c ká»³ quan trá»ng**:

* Backend **KHÃ”NG:

  * tháº¥y localStorage
  * tháº¥y browser
  * tháº¥y cart
  * tháº¥y voucher user chá»n**

ğŸ‘‰ Backend **chá»‰ biáº¿t nhá»¯ng gÃ¬ frontend gá»­i lÃªn**

---

## 2ï¸âƒ£ FRONTEND â€œNÃ“Iâ€ CHO BACKEND Báº°NG CÃCH NÃ€O?

ğŸ‘‰ **Báº°NG HTTP REQUEST (API CALL)**

---

## 3ï¸âƒ£ Cá»¤ THá»‚: FRONTEND Gá»¬I CÃI GÃŒ?

### ğŸ“¦ Khi user báº¥m Preview / Checkout

Frontend gá»­i **JSON**:

```json
{
  "cart": [
    { "variant_id": 101, "quantity": 2 },
    { "variant_id": 205, "quantity": 1 }
  ],
  "voucher_codes": ["SALE10", "SHOP5"]
}
```

ğŸ“Œ Ã nghÄ©a:

* `variant_id`: **ID duy nháº¥t** backend dÃ¹ng Ä‘á»ƒ truy DB
* `quantity`: sá»‘ lÆ°á»£ng user muá»‘n mua
* `voucher_codes`: mÃ£ voucher user chá»n

---

## 4ï¸âƒ£ BACKEND BIáº¾T VARIANT LÃ€ GÃŒ NHÆ¯ THáº¾ NÃ€O?

Backend lÃ m:

```sql
SELECT *
FROM product_variant
WHERE variant_id = 101;
```

ğŸ“Œ VÃ¬:

* `variant_id` lÃ  **PRIMARY KEY**
* LÃ  ngÃ´n ngá»¯ chung giá»¯a frontend â†” backend â†” database

ğŸ‘‰ **ID chÃ­nh lÃ  â€œdÃ¢y ná»‘iâ€ giá»¯a cÃ¡c táº§ng**

---

## 5ï¸âƒ£ BACKEND BIáº¾T VOUCHER LÃ€ GÃŒ?

```sql
SELECT *
FROM voucher
WHERE code = 'SALE10';
```

ğŸ“Œ Voucher Ä‘Ã£ tá»“n táº¡i sáºµn trong DB
Frontend **chá»‰ gá»­i code**, khÃ´ng gá»­i logic

---

## 6ï¸âƒ£ AI Táº O RA `variant_id` & `voucher_code`?

ğŸ‘‰ **DATABASE táº¡o trÆ°á»›c**

* Variant:

  * Ä‘Æ°á»£c import CSV
  * hoáº·c nháº­p tay
* Voucher:

  * do admin táº¡o

Frontend:

* chá»‰ hiá»ƒn thá»‹
* user click â†’ lÆ°u ID / code

---

## 7ï¸âƒ£ SÆ  Äá»’ Cá»°C Ká»² QUAN TRá»ŒNG

```
Database
   â†‘
   â”‚ (SELECT by id)
Backend
   â†‘
   â”‚ (JSON: variant_id, voucher_code)
Frontend
```

âŒ KhÃ´ng cÃ³ Ä‘á»c ngÆ°á»£c
âŒ KhÃ´ng cÃ³ tá»± Ä‘oÃ¡n

---

## 8ï¸âƒ£ VÃ Dá»¤ Ráº¤T THá»°C Táº¾

### User click â€œAdd to cartâ€:

```js
addToCart(variant_id = 101)
```

Frontend lÆ°u:

```json
{ "variant_id": 101, "quantity": 1 }
```

### User click â€œCheckoutâ€:

Frontend gá»­i **toÃ n bá»™ cart** cho backend

ğŸ‘‰ Backend **lÃºc nÃ y má»›i biáº¿t**

---

## 9ï¸âƒ£ CÃ‚U TRáº¢ Lá»œI CHUáº¨N Äá»‚ Báº¢O Vá»†

Báº¡n nÃ³i cÃ¢u nÃ y lÃ  xong ğŸ‘‡

> â€œBackend khÃ´ng tá»± biáº¿t dá»¯ liá»‡u ngÆ°á»i dÃ¹ng chá»n. Frontend gá»­i danh sÃ¡ch variant_id vÃ  voucher_code thÃ´ng qua API khi preview hoáº·c checkout, backend dá»±a vÃ o cÃ¡c ID Ä‘Ã³ Ä‘á»ƒ truy váº¥n dá»¯ liá»‡u trong database.â€

ğŸ’¯ CÃ¢u nÃ y **chuáº©n kiáº¿n trÃºc clientâ€“server**.

---

## 10ï¸âƒ£ TÃ“M Táº®T 1 DÃ’NG (CHá»T Háº )

> **ID lÃ  ngÃ´n ngá»¯ chung.
> Frontend gá»­i ID â†’ backend truy DB â†’ há»‡ thá»‘ng hoáº¡t Ä‘á»™ng.**

---

Náº¿u báº¡n muá»‘n, bÆ°á»›c tiáº¿p theo há»£p lÃ½ nháº¥t lÃ :

* ğŸ”„ Váº½ **sequence diagram: user â†’ frontend â†’ backend â†’ DB**
* ğŸ§  Giáº£i thÃ­ch vÃ¬ sao **frontend khÃ´ng Ä‘Æ°á»£c gá»­i giÃ¡**
* ğŸ§ª Case user sá»­a localStorage â†’ backend cháº·n

ğŸ‘‰ Báº¡n há»i tiáº¿p Ä‘i, giá» báº¡n Ä‘Ã£ cháº¡m tá»›i **báº£n cháº¥t clientâ€“server rá»“i** ğŸ‘Œ

váº­y chá»‘t láº¡i lÃ  variant vÃ  voucher lÃ  lÆ°u táº¡m trÃªn frontend vÃ  khi checkout lÃ  cÃ¹ng lÃºc order, orderitem, ordervoucher Ä‘c táº¡o vÃ  nÃ³ sáº½ láº¥y thÃ´ng tin tá»« frontend nhá» API
ğŸ‘‰ **Gáº¦N ÄÃšNG, NHÆ¯NG MÃŒNH Sáº¼ CHá»ˆNH Láº I 1 CHÃšT Äá»‚ THÃ€NH â€œCHUáº¨N TUYá»†T Äá»Iâ€**
(vÃ¬ cÃ¡ch báº¡n nÃ³i hiá»‡n táº¡i *dá»… bá»‹ báº¯t báº»* náº¿u ghi y nguyÃªn trong report)

---

## âŒ CHá»– Cáº¦N Sá»¬A NHáº¸

> â€œvariant vÃ  voucher lÃ  **lÆ°u táº¡m trÃªn frontend**â€

âŒ **Sai tá»«**
âœ” **ÄÃºng Ã½ nhÆ°ng pháº£i nÃ³i láº¡i cho chuáº©n**

---

## âœ… CÃ‚U CHá»T CHUáº¨N (NÃŠN DÃ™NG)

> **Frontend chá»‰ lÆ°u táº¡m danh sÃ¡ch variant_id vÃ  voucher_code mÃ  ngÆ°á»i dÃ¹ng Ä‘Ã£ chá»n.
> Khi checkout, frontend gá»­i cÃ¡c ID nÃ y qua API Ä‘á»ƒ backend táº¡o Order, OrderItem vÃ  OrderVoucher.
> Backend truy váº¥n database Ä‘á»ƒ láº¥y thÃ´ng tin chÃ­nh xÃ¡c vÃ  lÆ°u dá»¯ liá»‡u giao dá»‹ch.**

ğŸ’¯ CÃ¢u nÃ y **khÃ´ng ai báº¯t báº» Ä‘Æ°á»£c**.

---

## ğŸ” CHá»T Láº I Tá»ªNG PHáº¦N (RÃ• 100%)

### 1ï¸âƒ£ FRONTEND LÆ¯U CÃI GÃŒ?

ğŸ‘‰ **KHÃ”NG lÆ°u variant hay voucher**

ğŸ‘‰ **Chá»‰ lÆ°u:**

```json
{
  "cart": [
    { "variant_id": 101, "quantity": 2 },
    { "variant_id": 205, "quantity": 1 }
  ],
  "voucher_codes": ["SALE10", "SHOP5"]
}
```

ğŸ“Œ ÄÃ¢y chá»‰ lÃ  **tham chiáº¿u**, khÃ´ng pháº£i dá»¯ liá»‡u gá»‘c

---

### 2ï¸âƒ£ KHI CHECKOUT â†’ ÄIá»€U GÃŒ Xáº¢Y RA?

âœ” CÃ™NG 1 LUá»’NG (transaction):

1. Frontend gá»­i cart + voucher_codes qua API
2. Backend:

   * Query ProductVariant báº±ng variant_id
   * Query Voucher báº±ng voucher_code
   * Validate
3. Táº¡o:

   * Order
   * OrderItem
   * OrderVoucher

ğŸ“Œ **Táº¥t cáº£ táº¡o cÃ¹ng lÃºc**

---

### 3ï¸âƒ£ BACKEND KHÃ”NG Láº¤Y GÃŒ TRá»°C TIáº¾P Tá»ª FRONTEND?

âŒ GiÃ¡
âŒ Giáº£m giÃ¡
âŒ Tá»•ng tiá»n
âŒ Stock

âœ” Chá»‰ láº¥y:

* variant_id
* quantity
* voucher_code

---

## ğŸ§  SÆ  Äá»’ CHá»T (Ráº¤T QUAN TRá»ŒNG)

```
Frontend (ID)
   â†“
Backend (logic)
   â†“
Database (truth)
```

---

## ğŸ TÃ“M Táº®T CUá»I CÃ™NG (1 ÄOáº N NGáº®N)

> **Variant vÃ  voucher khÃ´ng Ä‘Æ°á»£c lÆ°u táº¡m dÆ°á»›i dáº¡ng dá»¯ liá»‡u Ä‘áº§y Ä‘á»§ trÃªn frontend. Frontend chá»‰ lÆ°u cÃ¡c mÃ£ Ä‘á»‹nh danh (ID, code). Khi ngÆ°á»i dÃ¹ng checkout, backend nháº­n cÃ¡c mÃ£ nÃ y qua API, truy váº¥n database Ä‘á»ƒ láº¥y dá»¯ liá»‡u chÃ­nh xÃ¡c vÃ  táº¡o cÃ¡c báº£n ghi Order, OrderItem vÃ  OrderVoucher trong cÃ¹ng má»™t giao dá»‹ch.**

---

ğŸ‘‰ **CÃ¢u nÃ y báº¡n cÃ³ thá»ƒ dÃ¹ng lÃ m â€œkáº¿t luáº­n chÆ°Æ¡ngâ€ trong report**.

Náº¿u báº¡n muá»‘n:

* ğŸ§¾ MÃ¬nh viáº¿t láº¡i **1 Ä‘oáº¡n káº¿t luáº­n chÃ­nh thá»©c cho LAB211**
* ğŸ”„ Váº½ flowchart cuá»‘i cÃ¹ng â€œtá»« add to cart â†’ checkoutâ€
* ğŸ§  SoÃ¡t láº¡i toÃ n bá»™ ERD xem cÃ²n mÃ¢u thuáº«n nÃ o khÃ´ng

Báº¡n muá»‘n chá»‘t tiáº¿p pháº§n nÃ o?

tá»« Ä‘Ã¢y váº½ láº¡i flowchart dá»±a vÃ o nhá»¯ng ná»™i dung tá»« nÃ£y Ä‘áº¿n h
OK, **tá»›i Ä‘Ã¢y lÃ  thá»i Ä‘iá»ƒm CHá»T FLOWCHART**.
MÃ¬nh sáº½ **váº½ láº¡i flowchart báº±ng chá»¯ (chuáº©n nghiá»‡p vá»¥)** dá»±a **100% vÃ o toÃ n bá»™ ná»™i dung tá»« Ä‘áº§u tá»›i giá»**, khÃ´ng thÃªm â€“ khÃ´ng thiáº¿u â€“ khÃ´ng mÃ¢u thuáº«n.

Báº¡n cÃ³ thá»ƒ:

* váº½ láº¡i báº±ng draw.io / Visio / PowerPoint
* hoáº·c chÃ©p nguyÃªn logic nÃ y vÃ o report

---

# ğŸ§­ FLOWCHART CUá»I CÃ™NG â€“ USER MUA HÃ€NG (CHUáº¨N LAB211)

---

## ğŸ”µ START

**User truy cáº­p há»‡ thá»‘ng**

---

## ğŸ”¹ BÆ¯á»šC 1: XEM Sáº¢N PHáº¨M

* Há»‡ thá»‘ng hiá»ƒn thá»‹ Product + ProductVariant
* Dá»¯ liá»‡u láº¥y tá»« DB

```
User â†’ View Product
```

---

## ğŸ”¹ BÆ¯á»šC 2: ADD TO CART (FRONTEND)

### HÃ nh Ä‘á»™ng:

* User chá»n ProductVariant
* Nháº­p sá»‘ lÆ°á»£ng
* Click â€œAdd to cartâ€

### Xá»­ lÃ½:

* Frontend lÆ°u táº¡m:

  * `variant_id`
  * `quantity`
* LÆ°u vÃ o **localStorage / sessionStorage**

ğŸ“Œ **KHÃ”NG táº¡o Order**
ğŸ“Œ **KHÃ”NG ghi DB**

```
Add to Cart
â†’ Save variant_id, quantity (Frontend storage)
```

---

## ğŸ”¹ BÆ¯á»šC 3: XEM GIá» HÃ€NG (FRONTEND)

* Frontend Ä‘á»c dá»¯ liá»‡u tá»« localStorage
* Hiá»ƒn thá»‹ danh sÃ¡ch sáº£n pháº©m Ä‘Ã£ chá»n

```
Load Cart
â†’ Read localStorage
```

---

## ğŸ”¹ BÆ¯á»šC 4: CHá»ŒN VOUCHER (FRONTEND)

### HÃ nh Ä‘á»™ng:

* User xem danh sÃ¡ch voucher kháº£ dá»¥ng
* Chá»n / bá» voucher

### Xá»­ lÃ½:

* Frontend lÆ°u táº¡m:

  * `voucher_code[]`

ğŸ“Œ **KHÃ”NG ghi DB**
ğŸ“Œ **KHÃ”NG táº¡o OrderVoucher**

```
Select Voucher
â†’ Save voucher_code (Frontend storage)
```

---

## ğŸ”¹ BÆ¯á»šC 5: PREVIEW TÃNH TIá»€N (OPTIONAL â€“ KHUYáº¾N NGHá»Š)

### Frontend:

* Gá»­i API:

```json
cart + voucher_codes
```

### Backend:

* Validate táº¡m:

  * variant tá»“n táº¡i
  * voucher há»£p lá»‡
* TÃ­nh tiá»n **Æ°á»›c tÃ­nh**
* Tráº£ káº¿t quáº£ vá» frontend

ğŸ“Œ **KHÃ”NG lÆ°u DB**

```
Preview Order
â†’ Backend calculate (no DB write)
```

---

## ğŸ”¹ BÆ¯á»šC 6: CHECKOUT (CHá»T GIAO Dá»ŠCH)

### Frontend:

* Gá»­i API `/checkout`:

```json
cart + voucher_codes
```

---

### Backend â€“ xá»­ lÃ½ THEO THá»¨ Tá»°:

#### 6.1 Validate dá»¯ liá»‡u

* Kiá»ƒm tra ProductVariant tá»“n táº¡i
* Kiá»ƒm tra stock
* Kiá»ƒm tra voucher:

  * cÃ²n háº¡n
  * min_order_amount
  * stackable
  * priority

âŒ Náº¿u lá»—i â†’ reject

---

#### 6.2 Táº¡o Order

```text
Order:
- user_id
- status = CREATED
- created_at = NOW()
```

---

#### 6.3 Táº¡o OrderItem (snapshot)

* Vá»›i má»—i item trong cart:

```text
OrderItem:
- order_id
- variant_id
- price_snapshot
- quantity
- subtotal
```

---

#### 6.4 Ãp Voucher â†’ táº¡o OrderVoucher

```text
OrderVoucher:
- order_id
- voucher_id
- discount_amount
```

---

#### 6.5 TÃ­nh tiá»n cuá»‘i

```text
final_amount = total - total_discount
```

â†’ LÆ°u vÃ o Order

---

```
Checkout
â†’ Create Order
â†’ Create OrderItem
â†’ Create OrderVoucher
â†’ Calculate final_amount
```

---

## ğŸ”¹ BÆ¯á»šC 7: THANH TOÃN

### Náº¿u thanh toÃ¡n thÃ nh cÃ´ng:

* Update Order.status = PAID
* Trá»« stock ProductVariant

```
Payment Success
â†’ Order.status = PAID
â†’ Update stock
```

---

### Náº¿u user khÃ´ng thanh toÃ¡n:

* Order váº«n CREATED
* CÃ³ thá»ƒ timeout (vÃ­ dá»¥ 30 phÃºt)
* Chuyá»ƒn sang CANCELLED

---

## ğŸ”¹ BÆ¯á»šC 8: SHIPPING â†’ COMPLETED

* Sau PAID + 1 ngÃ y:

  * status = SHIPPING
* Sau SHIPPING + 2 ngÃ y:

  * status = COMPLETED

ğŸ“Œ KhÃ´ng cho cancel khi SHIPPING / COMPLETED

---

## ğŸŸ¢ END

---

# ğŸ§  TÃ“M Táº®T FLOW (1 DÃ’NG CHá»T)

```
Add to cart (frontend)
â†’ chá»n voucher (frontend)
â†’ preview (optional)
â†’ checkout
â†’ create order + orderitem + ordervoucher
â†’ payment
â†’ update stock
â†’ completed
```

---

## ğŸ“Œ NHá»®NG ÄIá»‚M QUAN TRá»ŒNG ÄÃƒ ÄÆ¯á»¢C GIáº¢I QUYáº¾T

âœ” KhÃ´ng táº¡o Order quÃ¡ sá»›m
âœ” KhÃ´ng voucher háº¿t háº¡n vÃ´ lÃ½
âœ” OrderItem cÃ³ order_id
âœ” KhÃ´ng mÃ¢u thuáº«n stock
âœ” Dá»¯ liá»‡u lá»‹ch sá»­ an toÃ n

---

Náº¿u báº¡n muá»‘n bÆ°á»›c tiáº¿p theo, mÃ¬nh cÃ³ thá»ƒ:

* ğŸ¨ Chuyá»ƒn flow nÃ y sang **flowchart hÃ¬nh khá»‘i (Ä‘á»ƒ váº½ draw.io)**
* ğŸ§¾ Viáº¿t **mÃ´ táº£ flow báº±ng vÄƒn há»c thuáº­t cho report**
* ğŸ”„ Äá»‘i chiáº¿u flow nÃ y vá»›i **ERD cuá»‘i cÃ¹ng**

ğŸ‘‰ Báº¡n chá»n tiáº¿p: **váº½ hÃ¬nh**, **soÃ¡t ERD**, hay **viáº¿t report**?
